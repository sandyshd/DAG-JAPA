name: Manual Deploy to Azure Web App (Windows)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (development or production)'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - production
      app_name:
        description: 'Azure Web App name (existing)'
        required: true
        default: 'dag-japa-dev-webapp'
      resource_group:
        description: 'Azure Resource Group where Web App exists'
        required: true
        default: 'DAG-JAPA-Dev-RG'
      deploy_database:
        description: 'Run Prisma migrations?'
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  validate-build:
    name: Validate & Build
    runs-on: ubuntu-latest
    outputs:
      build_artifact: ${{ steps.bundle.outputs.package-path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint || true

      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prisma generate
        run: npm run prisma:generate || npx prisma generate

      - name: Debug Next.js runtime files
        run: |
          echo "Listing contents of node_modules/next/server to verify require-hook.js exists..."
          ls -R node_modules/next/server || true

      - name: Package deployable (flattened ZIP)
        id: bundle
        run: |
          rm -f deploy-package.zip || true
          # Create ZIP with built app files; exclude node_modules (will be installed by server.js on first run)
          # Include: app, lib, types (source code), built .next, package files, public assets, prisma, web.config, server.js
          zip -r deploy-package.zip \
            app lib types .next package.json package-lock.json public next.config.js prisma README.md web.config server.js \
            -x "**/node_modules/*" "**/node_modules/.cache/*" ".git/*" ".github/*" ".deployment" "deploy.cmd" "deploy.sh" "deploy-package.zip"

          # Validate that key files are in the ZIP
          echo "ZIP package created. Validating contents..."
          validation_failed=false
          
          for check in "package.json" ".next/" "web.config" "server.js" "app/" "lib/" "types/"; do
            if ! unzip -l deploy-package.zip | grep -q "$check"; then
              echo "ERROR: $check not found in ZIP"
              validation_failed=true
            else
              echo "✓ $check found in ZIP"
            fi
          done
          
          if [ "$validation_failed" = "true" ]; then
            echo "ZIP validation FAILED - missing critical files"
            echo "ZIP contents:"
            unzip -l deploy-package.zip | head -30
            exit 1
          fi

          echo "ZIP validation passed. All critical files present."
          echo "package-path=deploy-package.zip" >> $GITHUB_OUTPUT

      - name: Upload deploy package
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy-package.zip

  migrate-db:
    name: Run Prisma Migrations
    needs: validate-build
    if: ${{ github.event.inputs.deploy_database == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets[ format('DATABASE_URL_{0}', github.event.inputs.environment) ] }}
        run: npx prisma migrate deploy

  deploy-webapp:
    name: Deploy to Azure Web App (Windows)
    needs: [validate-build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure App Service settings for reliability
        run: |
          RG="${{ github.event.inputs.resource_group }}"
          APP="${{ github.event.inputs.app_name }}"
          
          echo "Configuring App Service for optimal deployment..."
          
          # Enable Always On so npm install can run and app doesn't sleep
          az webapp config set \
            --resource-group "$RG" \
            --name "$APP" \
            --always-on true
          
          # Set 32-bit platform (more stable on Windows for Node.js)
          az webapp config set \
            --resource-group "$RG" \
            --name "$APP" \
            --use-32bit-worker-process false
          
          echo "App Service configured"

      - name: Ensure app settings (base)
        run: |
          az webapp config appsettings set \
            --resource-group "${{ github.event.inputs.resource_group }}" \
            --name "${{ github.event.inputs.app_name }}" \
            --settings SCM_DO_BUILD_DURING_DEPLOYMENT=false NODE_ENV=production WEBSITE_NODE_DEFAULT_VERSION=20-lts

      - name: Ensure startup command (Windows, conditional)
        run: |
          RG="${{ github.event.inputs.resource_group }}"
          APP="${{ github.event.inputs.app_name }}"
          
          echo "Configuring startup command..."
          
          # For Windows App Service, use server.js wrapper which installs dependencies and starts Next.js
          az webapp config appsettings set \
            --resource-group "$RG" \
            --name "$APP" \
            --settings STARTUP="node server.js"
          
          echo "Startup command configured to: node server.js"
          
          # Verify the setting was applied
          echo "Verifying STARTUP setting..."
          az webapp config appsettings list --resource-group "$RG" --name "$APP" | grep -i "STARTUP" || echo "WARNING: STARTUP setting not found in app settings"

      - name: Download deploy package
        uses: actions/download-artifact@v4
        with:
          name: deploy-package
          path: .

      - name: Validate deploy package
        run: |
          echo "Validating deploy package..."
          if [ ! -f deploy-package.zip ]; then
            echo "ERROR: deploy-package.zip not found!"
            exit 1
          fi
          
          zip_size=$(stat -f%z deploy-package.zip 2>/dev/null || stat -c%s deploy-package.zip)
          echo "ZIP package size: $zip_size bytes"
          
          if [ $zip_size -lt 1000 ]; then
            echo "ERROR: ZIP package is suspiciously small ($zip_size bytes)"
            exit 1
          fi
          
          echo "ZIP package validation passed."
          echo "Contents summary:"
          unzip -l deploy-package.zip | head -20

      - name: Deploy ZIP to Web App (Windows)
        run: |
          set -e
          RG="${{ github.event.inputs.resource_group }}"
          APP="${{ github.event.inputs.app_name }}"
          
          echo "Starting deployment of deploy-package.zip to $APP"
          echo "ZIP file size: $(ls -lh deploy-package.zip | awk '{print $5}')"
          
          # Attempt deployment with retry logic
          deployment_succeeded=false
          for attempt in 1 2 3; do
            echo "Deployment attempt $attempt/3..."
            if az webapp deploy \
              --resource-group "$RG" \
              --name "$APP" \
              --src-path deploy-package.zip \
              --type zip 2>&1; then
              echo "Deployment succeeded on attempt $attempt"
              deployment_succeeded=true
              break
            else
              exit_code=$?
              echo "Deployment attempt $attempt failed with exit code $exit_code"
              if [ $attempt -lt 3 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          if [ "$deployment_succeeded" = "false" ]; then
            echo "All deployment attempts failed. Fetching Kudu logs..."
            az webapp log tail --resource-group "$RG" --name "$APP" --lines 50 || true
            exit 1
          fi

      - name: Restart Web App
        run: |
          RG="${{ github.event.inputs.resource_group }}"
          APP="${{ github.event.inputs.app_name }}"
          
          echo "Restarting Web App..."
          az webapp restart --resource-group "$RG" --name "$APP"
          
          echo "Waiting for app to start (20 seconds)..."
          sleep 20

      - name: Health check URL
        run: |
          APP_URL="https://${{ github.event.inputs.app_name }}.azurewebsites.net"
          RG="${{ github.event.inputs.resource_group }}"
          APP="${{ github.event.inputs.app_name }}"
          
          echo "=========================================="
          echo "Performing health checks"
          echo "=========================================="
          echo "App URL: $APP_URL"
          echo ""
          
          echo "Waiting for app to be ready..."
          echo "Note: On first deployment, npm install will run on app startup (3-10 minutes)"
          echo ""
          
          # Try 150 times (15 minutes at 6-second intervals)
          success=false
          for i in {1..150}; do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" "${APP_URL}/api/health" 2>/dev/null || echo "000")
            
            if [ "$http_code" = "200" ]; then
              echo "✓ SUCCESS: Health check passed (HTTP 200)"
              success=true
              break
            fi
            
            # Print progress every 30 seconds
            if [ $((i % 5)) -eq 0 ]; then
              elapsed=$((i * 6))
              remaining=$(((150 - i) * 6))
              echo "  Attempt $i/150 - HTTP $http_code - Elapsed: ${elapsed}s, Remaining: ~${remaining}s"
            fi
            
            sleep 6
          done
          
          if [ "$success" = false ]; then
            echo ""
            echo "✗ FAILED: Health check did not pass after 15 minutes"
            echo ""
            echo "Diagnostic information:"
            echo "========================"
            echo ""
            echo "App settings:"
            az webapp config appsettings list --resource-group "$RG" --name "$APP" | grep -E "STARTUP|NODE_ENV|WEBSITE_RUN_FROM_PACKAGE" || true
            echo ""
            echo "Deployment logs:"
            az webapp log deployment show --resource-group "$RG" --name "$APP" || echo "Could not fetch logs"
            echo ""
            echo "Next steps:"
            echo "1. Check Azure Portal: Configuration → Always On should be ON"
            echo "2. Check wwwroot folder contents in Kudu: https://${APP}.scm.azurewebsites.net/DebugConsole"
            echo "3. Run: npm install --production manually in the Kudu console"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "Deployment successful!"
          echo "=========================================="

  notify:
    name: Notification
    needs: deploy-webapp
    runs-on: ubuntu-latest
    steps:
      - name: Report
        run: |
          echo "Deployment to ${{ github.event.inputs.environment }} complete. App: https://${{ github.event.inputs.app_name }}.azurewebsites.net"