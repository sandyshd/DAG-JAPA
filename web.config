<?xml version="1.0" encoding="utf-8"?>
<!--
  web.config for Node.js on Windows App Service
  Configures IIS to proxy requests to the Node.js server running on localhost:3000
  Also ensures npm install runs on startup via startup hook
-->
<configuration>
  <system.webServer>
    <!-- Enable URL rewriting for SPA routing -->
    <rewrite>
      <rules>
        <rule name="HandleNodeRequests" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="/" />
        </rule>
      </rules>
    </rewrite>

    <!-- Forward all requests to the Node.js server -->
    <webSocket enabled="true" />
    <httpPlatform name="node" arguments="server.js" processPath="node.exe" stdoutLogEnabled="true" stdoutLogFile=".\logs\node.log" startupTimeLimit="60" requestTimeout="00:04:00">
      <environmentVariables>
        <environmentVariable name="NODE_ENV" value="production" />
        <environmentVariable name="PORT" value="3000" />
      </environmentVariables>
    </httpPlatform>

    <!-- Compression settings -->
    <staticContent>
      <clientCache cacheControlMode="UseExpires" httpExpires="Sun, 29 Mar 2020 00:00:00 GMT" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
    </staticContent>

    <urlCompression doStaticCompression="true" doDynamicCompression="true" />

    <!-- Logging -->
    <httpLogging>
      <selectiveLogging logAllTuples="false" />
    </httpLogging>
  </system.webServer>

  <!-- App Service specific settings -->
  <appSettings>
    <add key="StorageAccount" value="" />
  </appSettings>
</configuration>
